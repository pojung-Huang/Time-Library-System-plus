<template>
    <div class="scroll-wrapper">
        <div class="intro">
            <div class="history-bg">
                <h1 class="history-title">È†êÁ¥ÑË®òÈåÑ</h1>

                <!-- ÁôªÂÖ•Ê™¢Êü• -->
                <LoginRequiredPrompt v-if="!isLoggedIn" message="ÊÇ®ÈúÄË¶ÅÁôªÂÖ•ÊâçËÉΩÊü•Ë©¢È†êÁ¥ÑÁ¥ÄÈåÑ" />

                <!-- È†êÁ¥ÑË®òÈåÑÂÖßÂÆπÔºàÂè™ÊúâÁôªÂÖ•ÂæåÊâçÈ°ØÁ§∫Ôºâ -->
                <div v-else class="history-main">
                    <!-- ÊéßÂà∂Èù¢Êùø -->
                    <div class="history-control-panel">
                        <div class="history-control-panel-left">
                            <div class="history-row">
                                <span class="history-label">ÊØèÈ†ÅÈ°ØÁ§∫Ôºö</span>
                                <select v-model="itemsPerPage" class="history-select pretty-select-page">
                                    <option v-for="size in pageSizes" :key="size" :value="size">{{ size }} Á≠Ü</option>
                                </select>
                            </div>
                            <div class="history-row">
                                <span class="history-label">ÊéíÂ∫èÔºö</span>
                                <select v-model="sortConfig.field" class="history-select pretty-select">
                                    <option value="title">Êõ∏Âêç</option>
                                    <option value="author">‰ΩúËÄÖ</option>
                                    <option value="pickupTime">ÂèñÊõ∏ÊôÇÈñì</option>
                                </select>
                                <button @click="toggleSortOrder" class="history-sort-btn">
                                    {{ sortConfig.ascending ? '‚Üë ÂçáÂÜ™' : '‚Üì ÈôçÂÜ™' }}
                                </button>
                            </div>
                        </div>
                        <div class="history-control-panel-right">
                            <button @click="viewMode = 'table'"
                                :class="['history-view-btn', viewMode === 'table' ? 'history-view-btn-active' : '']">
                                Ë°®Ê†º
                            </button>
                            <button @click="viewMode = 'grid'"
                                :class="['history-view-btn', viewMode === 'grid' ? 'history-view-btn-active' : '']">
                                Á∂≤Ê†º
                            </button>
                        </div>
                    </div>

                    <!-- ÊâπÈáèÊìç‰ΩúÈù¢Êùø -->
                    <div v-if="reservationBooks.length > 0" class="batch-control-panel">
                        <div class="batch-control-left">
                            <label class="batch-checkbox-label">
                                <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll"
                                    class="batch-checkbox" />
                                <span>ÂÖ®ÈÅ∏</span>
                            </label>
                            <span class="batch-info">
                                Â∑≤ÈÅ∏Êìá {{ selectedBooks.length }} Á≠ÜË®òÈåÑ
                            </span>
                        </div>
                        <div class="batch-control-right">
                            <button @click="handleBatchCancel" class="batch-btn batch-btn-remove"
                                :disabled="selectedBooks.length === 0">
                                ÊâπÈáèÂèñÊ∂à ({{ selectedBooks.length }})
                            </button>
                        </div>
                    </div>

                    <!-- ËºâÂÖ•‰∏≠ÁãÄÊÖã -->
                    <div v-if="loading" class="history-loading">
                        <div class="history-loading-spinner"></div>
                        <p>ËºâÂÖ•‰∏≠...</p>
                    </div>

                    <!-- ÈåØË™§‰ø°ÊÅØ -->
                    <div v-else-if="error" class="history-error">
                        <div class="history-error-icon">!</div>
                        <p>{{ error }}</p>
                        <pre class="history-error-details">{{ error }}</pre>
                    </div>

                    <!-- ÁÑ°Ë≥áÊñôÁãÄÊÖã -->
                    <div v-else-if="!paginatedBooks.length" class="history-empty">
                        <div class="history-empty-icon">üìö</div>
                        <p>ÁõÆÂâçÊ≤íÊúâÈ†êÁ¥ÑË®òÈåÑ</p>
                        <p class="history-empty-subtitle">ÊÇ®ÈÇÑÊ≤íÊúâ‰ªª‰ΩïÈ†êÁ¥ÑË®òÈåÑ</p>
                    </div>

                    <!-- Ë°®Ê†ºË¶ñÂúñ -->
                    <div v-else
                        :class="['history-table-scroll', itemsPerPage > 10 ? 'history-table-scrollable' : 'history-table-fill']">
                        <div v-if="viewMode === 'table'" class="history-grid-table">
                            <div class="history-grid-header">
                                <div class="history-grid-checkbox">
                                    <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll"
                                        class="batch-checkbox" />
                                </div>
                                <div>Êõ∏Âêç</div>
                                <div>‰ΩúËÄÖ</div>
                                <div>ÂèñÊõ∏Âú∞Èªû</div>
                                <div>ÂèñÊõ∏ÊñπÂºè</div>
                                <div>ÂèñÊõ∏ÊôÇÈñì</div>
                                <div>ÁãÄÊÖã</div>
                                <div>Êìç‰Ωú</div>
                            </div>
                            <div class="history-grid-body">
                                <div v-for="(reservation, index) in paginatedBooks" :key="index"
                                    :class="['history-grid-row', { 'is-cancelled': reservation.status === 'cancelled' }]"
                                    @click="handleRowClick(reservation.reservationId)">
                                    <div class="history-grid-checkbox">
                                        <input type="checkbox"
                                            :checked="selectedBooks.includes(reservation.reservationId)"
                                            @change="toggleSelectBook(reservation.reservationId)" class="batch-checkbox"
                                            :disabled="reservation.status === 'cancelled'" @click.stop />
                                    </div>
                                    <div class="history-grid-title-cell">{{ reservation.title }}</div>
                                    <div>{{ reservation.author }}</div>
                                    <div>{{ reservation.pickupLocation }}</div>
                                    <div>{{ reservation.pickupMethod }}</div>
                                    <div>{{ reservation.pickupTime }}</div>
                                    <div :class="['history-status', getStatusClass(reservation.status)]">
                                        {{ getStatusText(reservation.status) }}
                                    </div>
                                    <div class="history-grid-actions" @click.stop>
                                        <button @click="viewBookDetail(reservation)"
                                            class="history-detail-btn">Ë©≥ÊÉÖ</button>
                                        <button @click="handleCancel(reservation.reservationId)"
                                            class="history-cancel-btn"
                                            :disabled="reservation.status === 'cancelled'">ÂèñÊ∂àÈ†êÁ¥Ñ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-else class="history-grid">
                            <div v-for="(reservation, index) in paginatedBooks" :key="index"
                                :class="['history-grid-card', { 'is-cancelled': reservation.status === 'cancelled' }]">
                                <div class="history-grid-card-header">
                                    <input type="checkbox" :checked="selectedBooks.includes(reservation.reservationId)"
                                        @change="toggleSelectBook(reservation.reservationId)" class="batch-checkbox"
                                        :disabled="reservation.status === 'cancelled'" />
                                </div>
                                <div class="history-grid-img-wrap">
                                    <img :src="getDefaultCoverUrl(index)" :alt="reservation.title"
                                        class="history-grid-img" />
                                </div>
                                <div class="history-grid-info">
                                    <h3 class="history-grid-title reservation-record-book-title">{{ reservation.title }}
                                    </h3>
                                    <p class="history-grid-author">‰ΩúËÄÖÔºö{{ reservation.author }}</p>
                                    <div class="history-grid-dates">
                                        <p>ÂèñÊõ∏Âú∞ÈªûÔºö{{ reservation.pickupLocation }}</p>
                                        <p>ÂèñÊõ∏ÊñπÂºèÔºö{{ reservation.pickupMethod }}</p>
                                        <p>ÂèñÊõ∏ÊôÇÈñìÔºö{{ reservation.pickupTime }}</p>
                                        <p>È†êÁ¥ÑÊó•ÊúüÔºö{{ reservation.reservationDate }}</p>
                                    </div>
                                    <div :class="['history-status', getStatusClass(reservation.status)]">
                                        {{ getStatusText(reservation.status) }}
                                    </div>
                                    <div class="history-grid-actions">
                                        <button class="history-detail-btn"
                                            @click="viewBookDetail(reservation)">Ë©≥ÊÉÖ</button>
                                        <button @click="handleCancel(reservation.reservationId)"
                                            class="history-cancel-btn"
                                            :disabled="reservation.status === 'cancelled'">ÂèñÊ∂àÈ†êÁ¥Ñ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÂàÜÈ†ÅÊéßÂà∂ -->
                    <div v-if="paginatedBooks.length" class="history-pagination">
                        <div class="history-pagination-controls">
                            <button class="history-pagination-btn" :disabled="currentPage === 1" @click="currentPage--">
                                <span aria-hidden="true">‚Üê</span>
                            </button>
                            <span>ÂÖ±{{ totalPages }}È†Å</span>
                            <input type="number" :value="currentPage" class="history-pagination-input" min="1"
                                :max="totalPages" @change="e => goToPage(parseInt(e.target.value))" />
                            <span>/{{ totalPages }}È†Å</span>
                            <button class="history-pagination-btn" :disabled="currentPage >= totalPages"
                                @click="currentPage++">
                                <span aria-hidden="true">‚Üí</span>
                            </button>
                        </div>
                        <div class="history-pagination-info">
                            È°ØÁ§∫Á¨¨ {{ (currentPage - 1) * itemsPerPage + 1 }} Âà∞ {{ Math.min(currentPage * itemsPerPage,
                                sortedBooks.length) }} Á≠ÜÔºåÂÖ± {{ sortedBooks.length }} Á≠Ü
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <CustomAlert :show="customAlert.show" :title="customAlert.title" :message="customAlert.message"
            :type="customAlert.type" @close="closeAlert" @confirm="confirmAction" />
    </div>
</template>

<script setup>
import { ref, computed, onMounted, watch, onUnmounted } from 'vue'
import { useRouter } from 'vue-router'
import { useHead } from '#imports'
import { reservationAPI } from '~/utils/api'
import CustomAlert from '~/components/CustomAlert.vue'

// Ë®≠ÁΩÆÈ†ÅÈù¢Ê®ôÈ°å
useHead({
    title: 'È†êÁ¥ÑË®òÈåÑ'
})

// Áç≤Âèñ router ÂØ¶‰æã
const router = useRouter()

// Ë¶ñÂúñÊ®°Âºè
const viewMode = ref('table')

// Ëá™Ë®ÇÊèêÁ§∫Ë¶ñÁ™ó
const customAlert = ref({
    show: false,
    title: '',
    message: '',
    type: 'alert', // 'alert' or 'confirm'
})
const pendingAction = ref(null);

const showAlert = (title, message) => {
    customAlert.value.title = title
    customAlert.value.message = message
    customAlert.value.type = 'alert'
    customAlert.value.show = true
}

const closeAlert = () => {
    customAlert.value.show = false
}

// ËôïÁêÜÂèñÊ∂àÈ†êÁ¥Ñ
function handleCancel(reservationId) {
    pendingAction.value = () => proceedWithCancellation(reservationId);
    customAlert.value = {
        show: true,
        title: 'Á¢∫Ë™çÂèñÊ∂à',
        message: 'ÊÇ®Á¢∫ÂÆöË¶ÅÂèñÊ∂àÈÄôÁ≠ÜÈ†êÁ¥ÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ',
        type: 'confirm',
    };
}

// Á¢∫Ë™çÂæåÂü∑Ë°åÂèñÊ∂à
async function proceedWithCancellation(reservationId) {
    try {
        const response = await reservationAPI.updateReservationStatus(reservationId, 'cancelled');
        if (response.status === 200 || response.status === 204) {
            showAlert('ÂèñÊ∂àÊàêÂäü', 'ÊÇ®ÁöÑÈ†êÁ¥ÑÂ∑≤ÊàêÂäüÂèñÊ∂à„ÄÇ');
            // ÈáçÊñ∞ËºâÂÖ•È†êÁ¥ÑÊ≠∑Âè≤
            await fetchReservations();
        } else {
            throw new Error('ÂèñÊ∂àÈ†êÁ¥ÑÊôÇÁôºÁîüÈåØË™§');
        }
    } catch (err) {
        console.error('ÂèñÊ∂àÈ†êÁ¥ÑÂ§±ÊïóÔºö', err);
        const message = err.response?.data?.message || 'ÂèñÊ∂àÈ†êÁ¥ÑÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ';
        showAlert('ÂèñÊ∂àÂ§±Êïó', message);
    }
}

// Áï∂Á¢∫Ë™ç‰∫ã‰ª∂Ëß∏ÁôºÊôÇË™øÁî®
const confirmAction = async () => {
    closeAlert();
    if (typeof pendingAction.value === 'function') {
        await pendingAction.value();
        pendingAction.value = null; // Reset
    }
};

// ÁôªÂÖ•ÁãÄÊÖãÊ™¢Êü•
const isLoggedIn = ref(false)
const user = ref(null)

// ÂàÜÈ†ÅË®≠ÂÆö
const pageSizes = [10, 20, 30, 50, 100]
const itemsPerPage = ref(10)
const currentPage = ref(1)

// ÊéíÂ∫èË®≠ÂÆö
const sortConfig = ref({
    field: 'title',
    ascending: true
})

// È†êË®≠Â∞ÅÈù¢ÂúñÁâá
function getDefaultCoverUrl(index) {
    return `https://via.placeholder.com/300x400/4ECDC4/FFFFFF?text=${encodeURIComponent('Êõ∏Á±çÂ∞ÅÈù¢')}`
}

// ÁãÄÊÖãËôïÁêÜÂáΩÊï∏
function getStatusText(status) {
    const statusMap = {
        'pending': 'ÂæÖÈ†òÂèñ',
        'completed': 'Â∑≤È†òÂèñ',
        'cancelled': 'Â∑≤ÂèñÊ∂à',
        'expired': 'Â∑≤ÈÅéÊúü',
        'PENDING': 'ÂæÖÈ†òÂèñ',
        'COMPLETED': 'Â∑≤È†òÂèñ',
        'CANCELLED': 'Â∑≤ÂèñÊ∂à',
        'EXPIRED': 'Â∑≤ÈÅéÊúü'
    }
    return statusMap[status] || status
}

function getStatusClass(status) {
    const statusClassMap = {
        'pending': 'history-status-pending',
        'completed': 'history-status-completed',
        'cancelled': 'history-status-cancelled',
        'expired': 'history-status-expired',
        'PENDING': 'history-status-pending',
        'COMPLETED': 'history-status-completed',
        'CANCELLED': 'history-status-cancelled',
        'EXPIRED': 'history-status-expired'
    }
    return statusClassMap[status] || 'history-status-pending'
}

// È†êÁ¥ÑË®òÈåÑË≥áÊñô
const reservationBooks = ref([])
const selectedBooks = ref([])
const loading = ref(false)
const error = ref(null)

// Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã
const checkLoginStatus = () => {
    // Ê™¢Êü• localStorage ‰∏≠ÁöÑÁî®Êà∂Ë≥áË®ä
    const storedUser = localStorage.getItem('user')
    const jwtToken = localStorage.getItem('jwt_token')
    const authToken = localStorage.getItem('authToken')

    console.log('=== ÁôªÂÖ•ÁãÄÊÖãÊ™¢Êü• ===')
    console.log('storedUser:', storedUser)
    console.log('jwtToken:', jwtToken)
    console.log('authToken:', authToken)

    if (storedUser) {
        try {
            user.value = JSON.parse(storedUser)
            isLoggedIn.value = true
            console.log('‚úÖ Áî®Êà∂Â∑≤ÁôªÂÖ•Ôºö', user.value)
        } catch (e) {
            console.error('‚ùå Ëß£ÊûêÁî®Êà∂Ë≥áË®äÂ§±ÊïóÔºö', e)
            isLoggedIn.value = false
        }
    } else if (jwtToken || authToken) {
        // Â¶ÇÊûúÊúâ token ‰ΩÜÊ≤íÊúâÁî®Êà∂Ë≥áË®äÔºå‰πüË¶ñÁÇ∫Â∑≤ÁôªÂÖ•
        isLoggedIn.value = true
        console.log('‚úÖ Ê™¢Ê∏¨Âà∞ÁôªÂÖ• token')
    } else {
        isLoggedIn.value = false
        console.log('‚ùå Áî®Êà∂Êú™ÁôªÂÖ•')
    }

    console.log('ÊúÄÁµÇÁôªÂÖ•ÁãÄÊÖãÔºö', isLoggedIn.value)
    console.log('==================')
}


// Ê†ºÂºèÂåñÊó•ÊúüÊôÇÈñì
function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return ''
    const date = new Date(dateTimeStr)
    return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    })
}

// Áç≤ÂèñÈ†êÁ¥ÑË®òÈåÑ
async function fetchReservations() {
    if (loading.value) return

    loading.value = true
    error.value = null

    try {
        console.log('ÈñãÂßãËºâÂÖ•È†êÁ¥ÑÊ≠∑Âè≤Ë®òÈåÑ...')

        let response
        try {
            // ‰∏çÂÇ≥ userIdÔºåËÆìÂæåÁ´ØËá™ÂãïÂæû token Ëß£Êûê
            response = await reservationAPI.getReservations()
        } catch (firstError) {
            console.log('‰∏çÂÇ≥ userId Â§±Êïó:', firstError)
            throw firstError
        }

        console.log('API ÂõûÂÇ≥Ë≥áÊñôÔºö', response.data)

        if (response.data && Array.isArray(response.data)) {
            reservationBooks.value = response.data.map((reservation, index) => {
                // ËôïÁêÜ reservations Ë°®ÁöÑË≥áÊñôÁµêÊßã
                const processedReservation = {
                    reservationId: reservation.reservation_id || reservation.id || `res_${index}`,
                    title: reservation.book_title || reservation.title || 'Êú™Áü•Êõ∏Âêç',
                    author: reservation.book_author || reservation.author || 'Êú™Áü•‰ΩúËÄÖ',
                    isbn: reservation.book_isbn || reservation.isbn || 'Êú™Áü•ISBN',
                    publisher: reservation.book_publisher || reservation.publisher || 'Êú™Áü•Âá∫ÁâàÁ§æ',
                    classification: reservation.classification || '',
                    categoryName: reservation.category_name || '',
                    pickupLocation: reservation.pickup_location || '‰∏ÄÊ®ìÊúçÂãôÂè∞', // È†êË®≠ÂèñÊõ∏Âú∞Èªû
                    pickupMethod: reservation.pickup_method || 'Ë¶™Ëá™ÂèñÊõ∏', // Êñ∞Â¢û
                    pickupTime: formatDateTime(reservation.reserve_time || reservation.pickup_time || ''),
                    reservationDate: formatDateTime(reservation.created_at || reservation.reservation_date || ''),
                    expiryDate: formatDateTime(reservation.expiry_date || reservation.updated_at || ''),
                    status: reservation.status || 'pending',
                    userId: reservation.user_id,
                    // ‰øùÂ≠òÂÆåÊï¥ÁöÑÂéüÂßãË≥áÊñôÔºå‰ª•‰æøË©≥ÊÉÖÈ†Å‰ΩøÁî®
                    bookInfo: {
                        bookId: reservation.book_id,
                        title: reservation.book_title || reservation.title,
                        author: reservation.book_author || reservation.author,
                        isbn: reservation.book_isbn || reservation.isbn,
                        publisher: reservation.book_publisher || reservation.publisher,
                        classification: reservation.classification,
                        category: {
                            cName: reservation.category_name
                        }
                    }
                }

                // Ëº∏Âá∫Á¨¨‰∏ÄÁ≠ÜË≥áÊñôÁöÑËôïÁêÜÁµêÊûú
                if (index === 0) {
                    console.log('Á¨¨‰∏ÄÁ≠ÜËôïÁêÜÂæåÁöÑÈ†êÁ¥ÑË®òÈåÑÔºö', JSON.stringify(processedReservation, null, 2))
                }

                return processedReservation
            })

            console.log('Á∏ΩÁ≠ÜÊï∏Ôºö', reservationBooks.value.length)
            console.log('ÂâçÁ´ØËôïÁêÜÂæåÁöÑ reservationBooksÔºö', reservationBooks.value)
        } else {
            console.log('API ÂõûÊáâ‰∏çÊòØÈô£ÂàóÊàñÁÇ∫Á©∫')
            reservationBooks.value = []
        }
    } catch (err) {
        console.error('Áç≤ÂèñÈ†êÁ¥ÑË®òÈåÑÂ§±ÊïóÔºö', err)
        console.log('ÈåØË™§Ë©≥ÊÉÖ:', {
            status: err.response?.status,
            statusText: err.response?.statusText,
            data: err.response?.data
        })
        error.value = 'ÁÑ°Ê≥ïËºâÂÖ•È†êÁ¥ÑË®òÈåÑÔºåË´ãÁ®çÂæåÂÜçË©¶'
        reservationBooks.value = []
    } finally {
        loading.value = false
    }
}

// Êü•ÁúãÊõ∏Á±çË©≥ÊÉÖ
function viewBookDetail(reservation) {
    console.log('ÈªûÊìäË©≥ÊÉÖÊåâÈàïÔºåÈ†êÁ¥ÑË≥áÊñôÔºö', reservation)

    if (reservation.bookInfo && reservation.bookInfo.isbn) {
        // ‰ΩøÁî® query ÂèÉÊï∏Ë∑≥ËΩâÂà∞ bookinfo È†ÅÈù¢
        const isbn = reservation.bookInfo.isbn
        console.log('Ë∑≥ËΩâÂà∞ bookinfo È†ÅÈù¢ÔºåISBNÔºö', isbn)

        router.push({
            path: '/bookinfo',
            query: {
                isbn: isbn,
                returnQuery: '',
                returnPage: '1',
                from: 'reservation-history',
                returnType: 'list'
            }
        })
    } else {
        console.warn('Áº∫Â∞ëÊõ∏Á±çË≥áË®äÊàñ ISBNÔºåÁÑ°Ê≥ïË∑≥ËΩâ')
        // ÂèØ‰ª•È°ØÁ§∫ÈåØË™§Ë®äÊÅØÊàñ‰ΩøÁî®È†êË®≠ÂÄº
        showAlert('ÊèêÁ§∫', 'ÁÑ°Ê≥ïÁç≤ÂèñÊõ∏Á±çË©≥ÊÉÖÔºåË´ãÁ®çÂæåÂÜçË©¶')
    }
}

// ÊéíÂ∫èÂäüËÉΩ
function toggleSortOrder() {
    sortConfig.value.ascending = !sortConfig.value.ascending
}

// ÊéíÂ∫èÂæåÁöÑË≥áÊñô
const sortedBooks = computed(() => {
    const books = [...reservationBooks.value]
    const field = sortConfig.value.field
    const ascending = sortConfig.value.ascending

    return books.sort((a, b) => {
        let valueA, valueB

        // Ê†πÊìö‰∏çÂêåÊ¨Ñ‰ΩçÈ°ûÂûãÈÄ≤Ë°åÊéíÂ∫è
        if (field === 'reservationDate') {
            valueA = new Date(a[field] || 0).getTime()
            valueB = new Date(b[field] || 0).getTime()
        } else {
            valueA = (a[field] || '').toString().toLowerCase()
            valueB = (b[field] || '').toString().toLowerCase()
        }

        // ÈÄ≤Ë°åÊéíÂ∫èÊØîËºÉ
        if (valueA < valueB) return ascending ? -1 : 1
        if (valueA > valueB) return ascending ? 1 : -1
        return 0
    })
})

// Ë®àÁÆóÁ∏ΩÈ†ÅÊï∏
const totalPages = computed(() => Math.ceil(sortedBooks.value.length / itemsPerPage.value))

// Ë®àÁÆóÁï∂ÂâçÈ†ÅÈù¢ÊáâË©≤È°ØÁ§∫ÁöÑË≥áÊñô
const paginatedBooks = computed(() => {
    const start = (currentPage.value - 1) * itemsPerPage.value
    const end = start + itemsPerPage.value
    return sortedBooks.value.slice(start, end)
})

// È†ÅÈù¢Ë∑≥ËΩâ
function goToPage(page) {
    const pageNum = parseInt(page)
    if (pageNum && !isNaN(pageNum) && pageNum >= 1 && pageNum <= totalPages.value) {
        currentPage.value = pageNum
    }
}

// Áõ£ËÅΩÊØèÈ†ÅÈ°ØÁ§∫Á≠ÜÊï∏ËÆäÂãïÔºåËá™ÂãïË∑≥ÂõûÁ¨¨‰∏ÄÈ†Å
watch(itemsPerPage, () => {
    currentPage.value = 1
})

// Áõ£ËÅΩÊéíÂ∫èË®≠ÂÆöËÆäÂåñ
watch([() => sortConfig.value.field, () => sortConfig.value.ascending], () => {
    // Áï∂ÊéíÂ∫èË®≠ÂÆöÊîπËÆäÊôÇÔºåÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ†Å
    currentPage.value = 1
})

// Êñ∞Â¢ûÔºöËôïÁêÜÊâπÈáèÂèñÊ∂à
async function handleBatchCancel() {
    const activeSelection = selectedBooks.value.filter(id => {
        const book = reservationBooks.value.find(b => b.reservationId === id);
        return book && book.status !== 'cancelled';
    });

    if (activeSelection.length === 0) {
        showAlert('ÊèêÁ§∫', 'Ë´ãÂÖàÈÅ∏ÊìáÊúâÊïàÁöÑÈ†êÁ¥ÑË®òÈåÑÈÄ≤Ë°åÂèñÊ∂à„ÄÇ');
        return;
    }

    pendingAction.value = () => proceedWithBatchCancellation(activeSelection);
    customAlert.value = {
        show: true,
        title: 'Á¢∫Ë™çÊâπÈáèÂèñÊ∂à',
        message: `ÊÇ®Á¢∫ÂÆöË¶ÅÂèñÊ∂àÈÅ∏ÂèñÁöÑ ${activeSelection.length} Á≠ÜÊúâÊïàÈ†êÁ¥ÑÂóéÔºü`,
        type: 'confirm',
    };
}

async function proceedWithBatchCancellation(idsToCancel) {
    try {
        await reservationAPI.batchCancelReservations(idsToCancel);

        // Á´ãÂç≥Êõ¥Êñ∞Êú¨Âú∞ÁãÄÊÖãÔºåËÆìÁî®Êà∂ËÉΩÁ´ãÂç≥ÁúãÂà∞Ë¶ñË¶∫ÊïàÊûú
        idsToCancel.forEach(id => {
            const reservation = reservationBooks.value.find(b => b.reservationId === id);
            if (reservation) {
                reservation.status = 'cancelled';
            }
        });

        showAlert('Êìç‰ΩúÂÆåÊàê', 'ÊâπÈáèÂèñÊ∂àÊìç‰ΩúÂ∑≤ÂÆåÊàê„ÄÇ');
        selectedBooks.value = [];

        // Âª∂ÈÅ≤ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñôÔºåÁ¢∫‰øùÂæåÁ´ØÁãÄÊÖãÂ∑≤Êõ¥Êñ∞
        setTimeout(async () => {
            await fetchReservations();
        }, 1000);
    } catch (err) {
        console.error('ÊâπÈáèÂèñÊ∂àÂ§±ÊïóÔºö', err);
        showAlert('ÈåØË™§', 'ÊâπÈáèÂèñÊ∂àÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
    }
}

// ===== ÈÅ∏ÂèñÊìç‰Ωú =====
const toggleSelectBook = (reservationId) => {
    const index = selectedBooks.value.indexOf(reservationId);
    if (index === -1) {
        selectedBooks.value.push(reservationId);
    } else {
        selectedBooks.value.splice(index, 1);
    }
};

const toggleSelectAll = () => {
    if (isAllSelected.value) {
        selectedBooks.value = [];
    } else {
        selectedBooks.value = paginatedBooks.value.map(book => book.reservationId);
    }
};

// ===== Ë®àÁÆóÂ±¨ÊÄß =====
const isAllSelected = computed(() => {
    if (paginatedBooks.value.length === 0) return false;
    return paginatedBooks.value.every(book => selectedBooks.value.includes(book.reservationId));
});

// ÂàùÂßãÂåñËºâÂÖ•Ë≥áÊñô
onMounted(async () => {
    checkLoginStatus()
    if (isLoggedIn.value) {
        try {
            await fetchReservations()
        } catch (err) {
            console.error('ÂàùÂßãÂåñËºâÂÖ•Â§±ÊïóÔºö', err)
        }
    }

    // Áõ£ËÅΩÁôªÂÖ•ÊàêÂäü‰∫ã‰ª∂
    const handleLoginSuccess = async () => {
        console.log('Êî∂Âà∞ÁôªÂÖ•ÊàêÂäü‰∫ã‰ª∂ÔºåÈáçÊñ∞Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã')
        checkLoginStatus()
        if (isLoggedIn.value) {
            try {
                await fetchReservations()
            } catch (err) {
                console.error('ÁôªÂÖ•ÂæåËºâÂÖ•Â§±ÊïóÔºö', err)
            }
        }
    }
    window.addEventListener('login-success', handleLoginSuccess)
})

// ÁµÑ‰ª∂Âç∏ËºâÊôÇÁßªÈô§‰∫ã‰ª∂Áõ£ËÅΩÂô®
onUnmounted(() => {
    const handleLoginSuccess = async () => {
        console.log('Êî∂Âà∞ÁôªÂÖ•ÊàêÂäü‰∫ã‰ª∂ÔºåÈáçÊñ∞Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã')
        checkLoginStatus()
        if (isLoggedIn.value) {
            try {
                await fetchReservations()
            } catch (err) {
                console.error('ÁôªÂÖ•ÂæåËºâÂÖ•Â§±ÊïóÔºö', err)
            }
        }
    }
    window.removeEventListener('login-success', handleLoginSuccess)
})

// Êñ∞Â¢ûÔºöËôïÁêÜË°åÈªûÊìä‰∫ã‰ª∂
function handleRowClick(reservationId) {
    // Ê™¢Êü•Ë©≤È†êÁ¥ÑÊòØÂê¶Â∑≤ÂèñÊ∂à
    const reservation = reservationBooks.value.find(r => r.reservationId === reservationId);
    if (reservation && reservation.status === 'cancelled') {
        return; // Â∑≤ÂèñÊ∂àÁöÑÈ†êÁ¥Ñ‰∏çËÉΩÈÅ∏Âèñ
    }

    // ÂàáÊèõË©≤Ë°åÁöÑÈÅ∏ÂèñÁãÄÊÖã
    const index = selectedBooks.value.indexOf(reservationId);
    if (index === -1) {
        selectedBooks.value.push(reservationId);
    } else {
        selectedBooks.value.splice(index, 1);
    }
}
</script>

<style scoped>
.scroll-wrapper {
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.intro {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
    background: transparent;
}

/* ÊªæÂãïÊ¢ùÈ†êË®≠ÁÇ∫ÈÄèÊòé */
.intro::-webkit-scrollbar {
    width: 8px;
}

.intro::-webkit-scrollbar-thumb {
    background-color: transparent;
    border-radius: 4px;
    transition: background-color 0.3s ease;
}

/* ÊªëÈº†Èù†Ëøë wrapper ÊôÇÈ°ØÁ§∫ÊªæÂãïÊ¢ù */
.scroll-wrapper:hover .intro::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.4);
}

/* ÊªëÈº†Èù†ËøëÊôÇÊªæÂãïÊ¢ùËÉåÊôØ‰πüÈ°ØÁ§∫ */
.scroll-wrapper:hover .intro {
    scrollbar-color: rgba(0, 0, 0, 0.4) transparent;
}

.history-bg {
    padding: 24px 24px 100px 24px;
    background: transparent;
}

.history-title {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 16px;
    color: #003366;
    text-align: center;
}

.history-main {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.history-control-panel {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 16px;
    flex-wrap: wrap;
}

.history-control-panel-left {
    display: flex;
    align-items: center;
    gap: 32px;
    flex-wrap: wrap;
}

.history-control-panel-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.history-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.history-label {
    font-size: 1rem;
    color: #222;
}

.history-select {
    min-width: 120px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 1rem;
    background: #fff;
    color: #18181b;
    cursor: pointer;
    transition: background 0.2s;
    height: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    text-align-last: center;
}

.history-select:hover {
    background: #f3f4f6;
}

.history-sort-btn {
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px 16px;
    background: #fff;
    color: #18181b;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    height: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 100px;
}

.history-view-btn {
    display: inline-flex;
    align-items: center;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #fff;
    color: #18181b;
    font-size: 1rem;
    padding: 8px 16px;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    margin-right: 4px;
}

.history-view-btn:last-child {
    margin-right: 0;
}

.history-view-btn-active {
    background: #2563eb;
    color: #fff;
}

.history-table-scroll {
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    border: 1px solid rgba(229, 231, 235, 0.4);
    overflow: hidden;
}

.history-table-scrollable {
    max-height: 600px;
    overflow-y: auto;
}

.history-table-fill {
    min-height: 400px;
}

.history-grid-table {
    width: 100%;
}

.history-grid-header {
    display: grid;
    grid-template-columns: 50px 2fr 1fr 1fr 1fr 1fr 1fr 200px;
    gap: 16px;
    padding: 16px 20px;
    background: rgba(243, 244, 246, 0.6);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(229, 231, 235, 0.4);
    font-weight: 600;
    color: #222;
    font-size: 0.95rem;
}

.history-grid-header>div:nth-child(n+2),
.history-grid-row>div:nth-child(n+2) {
    text-align: center;
    justify-content: center;
}

.history-grid-body {
    max-height: 500px;
    overflow-y: auto;
}

.history-grid-row {
    display: grid;
    grid-template-columns: 50px 2fr 1fr 1fr 1fr 1fr 1fr 200px;
    gap: 16px;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(229, 231, 235, 0.2);
    align-items: center;
    transition: background 0.2s;
    cursor: pointer;
}

.history-grid-row:hover {
    background: rgba(243, 244, 246, 0.3);
}

.history-grid-row:last-child {
    border-bottom: none;
}

.history-grid-title-cell {
    font-weight: 500;
    color: #18181b;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* ÁãÄÊÖãÊ®£Âºè */
.history-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
    text-align: center;
    min-width: 80px;
}

.history-status-pending {
    background: #fef3c7;
    color: #d97706;
    border: 1px solid #fbbf24;
}

.history-status-completed {
    background: #d1fae5;
    color: #059669;
    border: 1px solid #34d399;
}

.history-status-cancelled {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #f87171;
}

.history-status-expired {
    background: #f3f4f6;
    color: #6b7280;
    border: 1px solid #d1d5db;
}

.history-detail-btn {
    padding: 6px 12px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s;
}

.history-detail-btn:hover {
    background: #1d4ed8;
}

.history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    padding: 20px;
}

.history-grid-card {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    border: 1px solid rgba(229, 231, 235, 0.4);
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
}

.history-grid-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.history-grid-img-wrap {
    width: 100%;
    height: 200px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
}

.history-grid-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.history-grid-info {
    padding: 16px;
}

.history-grid-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #18181b;
    margin-bottom: 8px;
    line-height: 1.4;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.history-grid-author {
    font-size: 0.9rem;
    color: #4b5563;
    margin-bottom: 8px;
}

.history-grid-dates {
    font-size: 0.9rem;
    color: #4b5563;
    margin-bottom: 12px;
}

.history-grid-dates p {
    margin-bottom: 4px;
}

.history-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #4b5563;
}

.history-loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e5e7eb;
    border-top: 4px solid #2563eb;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }
}

.history-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #dc2626;
    text-align: center;
}

.history-error-icon {
    width: 48px;
    height: 48px;
    background: #dc2626;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 16px;
}

.history-error-details {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 4px;
    padding: 12px;
    margin-top: 12px;
    font-size: 0.9rem;
    color: #991b1b;
    max-width: 100%;
    overflow-x: auto;
}

.history-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
    text-align: center;
    color: #6b7280;
}

.history-empty-icon {
    font-size: 4rem;
    margin-bottom: 16px;
}

.history-empty-subtitle {
    font-size: 1rem;
    color: #9ca3af;
    margin-bottom: 24px;
}

.history-pagination {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 20px;
    background: transparent;
}

.history-pagination-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.history-pagination-btn {
    padding: 8px 12px;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
}

.history-pagination-btn:hover:not(:disabled) {
    background: #f3f4f6;
}

.history-pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.history-pagination-input {
    width: 60px;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    text-align: center;
    font-size: 0.9rem;
}

.history-pagination-info {
    font-size: 0.9rem;
    color: #6b7280;
}

/* ÈüøÊáâÂºèË®≠Ë®à */
@media (max-width: 768px) {
    .history-control-panel {
        flex-direction: column;
        align-items: stretch;
    }

    .history-control-panel-left,
    .history-control-panel-right {
        justify-content: center;
    }

    .batch-control-panel {
        flex-direction: column;
        gap: 16px;
    }

    .batch-control-left,
    .batch-control-right {
        justify-content: center;
    }

    .history-grid-header,
    .history-grid-row {
        grid-template-columns: 1fr 170px;
        font-size: 0.9rem;
    }

    .history-grid-header>div:nth-child(2),
    .history-grid-header>div:nth-child(3),
    .history-grid-header>div:nth-child(4),
    .history-grid-header>div:nth-child(5),
    .history-grid-header>div:nth-child(6),
    .history-grid-row>div:nth-child(2),
    .history-grid-row>div:nth-child(3),
    .history-grid-row>div:nth-child(4),
    .history-grid-row>div:nth-child(5),
    .history-grid-row>div:nth-child(6) {
        display: none;
    }

    .history-grid {
        grid-template-columns: 1fr;
    }
}

/* === ÊéßÂà∂Èù¢ÊùøÁæéÂåñÔºàËàá reservation-record.vue ÂÆåÂÖ®‰∏ÄËá¥Ôºâ=== */
.history-row .pretty-select,
.history-row .pretty-select-page {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: #fff url('data:image/svg+xml;utf8,<svg fill="%23256be9" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7.293 7.293a1 003 0 011.414 0L10 8.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z"/></svg>') no-repeat right 0.75rem center/1.2em auto;
    border: 1.5px solid #2563eb;
    border-radius: 8px;
    padding: 8px 36px 8px 16px;
    font-size: 1.05rem;
    color: #222;
    min-width: 110px;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.07);
    transition: border 0.2s, box-shadow 0.2s;
    text-align: center;
    cursor: pointer;
}

.history-row .pretty-select:focus,
.history-row .pretty-select-page:focus {
    border-color: #1976d2;
    outline: none;
    box-shadow: 0 0 0 2px #2563eb33;
}

.history-row .pretty-select option,
.history-row .pretty-select-page option {
    background: #fff;
    color: #222;
    text-align: left;
}

.history-sort-btn {
    border: 1.5px solid #2563eb;
    border-radius: 8px;
    background: #fff;
    color: #2563eb;
    font-size: 1.05rem;
    font-weight: 500;
    padding: 8px 20px;
    min-width: 90px;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.07);
    transition: background 0.2s, color 0.2s, border 0.2s;
    cursor: pointer;
}

.history-sort-btn:hover,
.history-sort-btn:focus {
    background: #2563eb;
    color: #fff;
    border-color: #1976d2;
}

.history-view-btn {
    border: 1.5px solid #2563eb;
    border-radius: 8px;
    background: #fff;
    color: #2563eb;
    font-size: 1.05rem;
    font-weight: 500;
    padding: 8px 20px;
    min-width: 90px;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.07);
    transition: background 0.2s, color 0.2s, border 0.2s;
    cursor: pointer;
    margin-right: 4px;
}

.history-view-btn:last-child {
    margin-right: 0;
}

.history-view-btn-active,
.history-view-btn:hover,
.history-view-btn:focus {
    background: #2563eb;
    color: #fff;
    border-color: #1976d2;
}

.history-grid-actions {
    display: flex;
    flex-wrap: nowrap;
    gap: 8px;
    justify-content: center;
    align-items: center;
}

.history-cancel-btn {
    padding: 6px 12px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s;
}

.history-cancel-btn:hover {
    background: #dc2626;
}

.history-grid-checkbox {
    display: flex;
    align-items: center;
    justify-content: center;
}

.batch-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #2563eb;
}

.history-grid-card-header {
    position: relative;
    padding: 12px;
    background: rgba(243, 244, 246, 0.6);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(229, 231, 235, 0.4);
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 12px;
}

.is-cancelled {
    color: #9ca3af;
    background-color: #f9fafb;
    text-decoration: line-through;
    cursor: not-allowed;
}

.is-cancelled .history-grid-title-cell,
.is-cancelled .history-grid-title {
    color: #9ca3af;
}

.history-cancel-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

/* ÊâπÈáèÊìç‰ΩúÈù¢ÊùøÊ®£Âºè */
.batch-control-panel {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(229, 231, 235, 0.4);
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 16px;
}

.batch-control-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.batch-control-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.batch-checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1rem;
    color: #222;
    cursor: pointer;
}

.batch-info {
    font-size: 0.95rem;
    color: #4b5563;
}

.batch-warning {
    font-size: 0.9rem;
    color: #dc2626;
    font-weight: 500;
}

.batch-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid;
}

.batch-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.batch-btn-remove {
    background: #fff;
    color: #dc2626;
    border-color: #dc2626;
}

.batch-btn-remove:hover:not(:disabled) {
    background: #dc2626;
    color: #fff;
}

.batch-btn-reserve {
    background: #2563eb;
    color: #fff;
    border-color: #2563eb;
}

.batch-btn-reserve:hover:not(:disabled) {
    background: #1d4ed8;
    border-color: #1d4ed8;
}
</style>